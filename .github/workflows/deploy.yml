name: ğŸš€ Deploy to Truehost

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: zinlink_front/project/package-lock.json
        
    - name: ğŸ“¦ Install frontend dependencies
      working-directory: zinlink_front/project
      run: npm ci
      
    - name: ğŸ—ï¸ Build frontend
      working-directory: zinlink_front/project
      run: npm run build
      
    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, iconv, json, mbstring, pdo, xml
        coverage: none
        
    - name: ğŸ“¦ Install backend dependencies
      working-directory: admin_zinlink
      run: composer install --no-dev --optimize-autoloader
      
    - name: ğŸ”‘ Generate Laravel key
      working-directory: admin_zinlink
      run: php artisan key:generate --no-interaction
      
    - name: ğŸ“ Create deployment package
      run: |
        mkdir -p deployment_temp
        cp -r zinlink_front/project/dist/* deployment_temp/
        cp -r admin_zinlink deployment_temp/api
        cp admin_zinlink/.env.example deployment_temp/api/.env
        echo "Deployment package created successfully"
        
    - name: ğŸ“¤ Deploy to Truehost
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.TRUEHOST_HOST }}
        username: ${{ secrets.TRUEHOST_USERNAME }}
        password: ${{ secrets.TRUEHOST_PASSWORD }}
        port: ${{ secrets.TRUEHOST_PORT }}
        source: "deployment_temp/*"
        target: "/public_html/"
        strip_components: 1
        
    - name: ğŸ”§ Run deployment commands
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.TRUEHOST_HOST }}
        username: ${{ secrets.TRUEHOST_USERNAME }}
        password: ${{ secrets.TRUEHOST_PASSWORD }}
        port: ${{ secrets.TRUEHOST_PORT }}
        script: |
          cd /public_html
          chmod -R 755 api/storage/
          chmod -R 755 api/bootstrap/cache/
          cd api
          php artisan storage:link
          php artisan migrate --force
          php artisan db:seed --force
          echo "ğŸš€ Deployment completed successfully!"
          
    - name: ğŸ§¹ Cleanup
      run: rm -rf deployment_temp
      
    - name: âœ… Deployment Status
      run: echo "ğŸ‰ Zinlink Tech deployed successfully to Truehost!" 